# CloudSOA Broker Ingress — Nginx Ingress Controller + TLS
#
# TLS Option 2: Nginx Ingress (free, runs as AKS pods)
#
# Prerequisites:
#   1. Install Nginx Ingress:
#      helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
#      helm install ingress-nginx ingress-nginx/ingress-nginx \
#        --namespace ingress-nginx --create-namespace \
#        --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz
#
#   2. (Optional) Install cert-manager for auto Let's Encrypt certs:
#      helm repo add jetstack https://charts.jetstack.io
#      helm install cert-manager jetstack/cert-manager \
#        --namespace cert-manager --create-namespace \
#        --set crds.enabled=true
#
#   3. Create TLS certificate (choose one):
#      a) cert-manager + Let's Encrypt (see ClusterIssuer below)
#      b) Manual: kubectl create secret tls cloudsoa-tls \
#           --cert=tls.crt --key=tls.key -n cloudsoa
#
# Usage:
#   1. Replace soa.yourcompany.com with your domain
#   2. kubectl apply -f broker-ingress-nginx.yaml
#
---
# (Optional) Let's Encrypt ClusterIssuer — uncomment if using cert-manager
# apiVersion: cert-manager.io/v1
# kind: ClusterIssuer
# metadata:
#   name: letsencrypt-prod
# spec:
#   acme:
#     server: https://acme-v02.api.letsencrypt.org/directory
#     email: admin@yourcompany.com
#     privateKeySecretRef:
#       name: letsencrypt-prod-key
#     solvers:
#       - http01:
#           ingress:
#             class: nginx
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: broker-ingress
  namespace: cloudsoa
  annotations:
    # Use Nginx ingress class
    kubernetes.io/ingress.class: nginx
    # Force HTTPS redirect
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Request timeout (5 min for long-running SOA operations)
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    # Max body size for DLL upload via ServiceManager
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    # (Optional) cert-manager auto-TLS — uncomment if using cert-manager
    # cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
    - hosts:
        - soa.yourcompany.com
      secretName: cloudsoa-tls
  rules:
    - host: soa.yourcompany.com
      http:
        paths:
          - path: /api/
            pathType: Prefix
            backend:
              service:
                name: broker-service
                port:
                  number: 80
          - path: /healthz
            pathType: Exact
            backend:
              service:
                name: broker-service
                port:
                  number: 80
